from dotenv import load_dotenv
from flask import Flask, render_template_string, request, render_template
import subprocess

app = Flask(__name__, static_folder='static', template_folder='templates')

load_dotenv(verbose=True, override=True, dotenv_path='.flaskenv')


@app.route('/', methods=['GET', 'POST'])
def trace_route():
    result = None
    if request.method == 'POST':
        target = request.form['target']

        # Безопасна проверка – само букви, цифри, точки и тирета
        import re
        if not re.match(r'^[a-zA-Z0-9.\-]+$', target):
            result = "❌ Невалиден адрес!"
        else:
            try:
                # Изпълняваме traceroute (или можеш да ползваш 'ip route get')
                output = subprocess.check_output(
                    ["traceroute", "-m", "15", target],  # до 10 хопа
                    stderr=subprocess.STDOUT,
                    text=True,
                    timeout=60
                )
                result = output
            except subprocess.CalledProcessError as e:
                result = f"❌ Грешка при изпълнение: {e.output}"
            except subprocess.TimeoutExpired:
                result = "⚠️ Времето за изпълнение изтече."

    return render_template("index.html", result=result)


if __name__ == '__main__':
    app.run()
